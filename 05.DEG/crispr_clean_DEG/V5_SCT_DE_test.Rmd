```{r}
options(echo = TRUE)

source("../../00.ref/config/CRISPR_clean_config.R")
seurat_output_dir <- glue("{out_dir_root}/04.seurat")
input_seurat <- glue("{seurat_output_dir}/seurat_04_05.rds")
DEG_out_dir <- glue("{out_dir_root}/05.DEG_717_filter")
dir.create(DEG_out_dir, showWarnings = FALSE, recursive = TRUE )

method <- "SCT"
BH_thres <- 0.01
lfc_thres <- 0.585
cluster_col <- "predicted.celltype.l2"
condition_col <- "diagnosis_general"
skip_cov <- FALSE
overwrite <- TRUE
print(glue("Overwrite toggile is {overwrite}"))


degs_path<-glue("{DEG_out_dir}/degs/sALS_hc/{method}")
plots_path<-glue("{DEG_out_dir}/plots/sALS_hc/{method}")

dir.create(DEG_out_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(degs_path, showWarnings = FALSE, recursive = TRUE)
dir.create(plots_path, showWarnings = FALSE, recursive = TRUE)

s<-readRDS(input_seurat)
DefaultAssay(s) <- "RNA"

# subset to not include
s<-subset(s, subset = diagnosis!="als_c9orf72")
print(s@meta.data$diagnosis|>unique())
print(s@meta.data$diagnosis_general|>unique())


# remove cells without valid cell type annotation, this is relevant when labels are generated by matching barcodes
# with a reference seurat object
cells.use<-s@meta.data[which(is.na(s@meta.data[[cluster_col]])==F),]|>rownames()
s<- subset(s, cells = cells.use)

# generate all comparison permutations
clusters <- s@meta.data[[cluster_col]] |> unique() |> sort()
sample_conditions <- s@meta.data[[condition_col]] |> unique() |> sort()

comparisons <- combinations(n = length(sample_conditions), r = 2, v = sample_conditions)
comparisons <- split(comparisons, seq(nrow(comparisons)))

# add diagnnosis_celltype to metadata for identity matching during DEG analysis
s@meta.data$diagnosis_cluster <- glue('{s@meta.data[[cluster_col]]} - {s@meta.data[[condition_col]]}')
Idents(s) <- 'diagnosis_cluster'

all_cov <- c("age_sex")

print("INFO: Covariates to test for:")
print(all_cov)
for (cur_cov in all_cov){
  dir.create(glue("{degs_path}/{cur_cov}"), showWarnings = TRUE)
  dir.create(glue("{plots_path}/{cur_cov}"), showWarnings = TRUE)
}




cluster <- "CD16 Mono"
comparison <- comparisons[[1]]
cur_s <- subset(s, diagnosis_cluster==glue("{cluster} - {comparison[1]}") | diagnosis_cluster==glue("{cluster} - {comparison[2]}"))
print(unique(cur_s$diagnosis_cluster))
    
    
t <- cur_s@meta.data$sample_id|>table()
samples_keep <- names(t[t>2])
cur_s <- subset(cur_s, sample_id %in% samples_keep)

# check if both comparison groups have at least 3 cells
ncell_1 <- nrow(dplyr::filter(cur_s@meta.data, diagnosis_cluster==glue("{cluster} - {comparison[1]}")))
ncell_2 <- nrow(dplyr::filter(cur_s@meta.data, diagnosis_cluster==glue("{cluster} - {comparison[2]}")))
if(ncell_1 < 3 | ncell_2 < 3){
  print("Skip due to inadequate cells in one group.")
  next
}

Idents(cur_s) <- condition_col
cur_s <- JoinLayers(cur_s)
cur_s_LFC <- FoldChange(object = cur_s, ident.1 = comparison[1], ident.2 = comparison[2], fc.name = "avg_log2FC", base = 2) %>% data.frame()

genes_keep_10pct <- row.names(cur_s_LFC)[cur_s_LFC$pct.1 >= 0.1 | cur_s_LFC$pct.2 >= 0.1]
genes_keep_1pct <- row.names(cur_s_LFC)[cur_s_LFC$pct.1 >= 0.01 & cur_s_LFC$pct.2 >= 0.01]
genes_keep <- intersect(genes_keep_10pct, genes_keep_1pct) 




```

